     1                                  ; bootsect.s
     2                                  ; =============================================================================
     3                                  ; load system
     4                                  ;
     5                                  ; =============================================================================
     6                                  ;
     7                                  ;
     8                                  ;
     9                                  ; memory allocation
    10                                  ;
    11                                  ;
    12                                  ;       0x7c00(boot)                                     0x90000(new boot)
    13                                  ;        /                                                /
    14                                  ;       / 0x10000                                        / 0x90200(setup)
    15                                  ;      | /                                              | /
    16                                  ;      ||<--    sys    -->|                             ||
    17                                  ;      ||                 |                             ||
    18                                  ; +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
    19                                  ; |     |                 |                             |                                         |
    20                                  ; +-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+-----+
    23                                  ; \                                                \                                               ;  \                                                \                                               ; 0x00000                                         0x7fff
    24                                  ;
    25                                  ;
    26                                  ;
    27                                  ;
    28                                  ; =============================================================================
    29                                  
    30                                  
    31                                  
    32                                  ; define global constants
    33                                  SYSSIZE		EQU 0x30000
    34                                  SETUPLEN	EQU 4
    35                                  BOOTSEG		EQU 0x07c0
    36                                  INITSEG		EQU 0x9000
    37                                  SETUPSEG	EQU 0x9020
    38                                  SYSSEG		EQU 0x1000
    39                                  ENDSEG		EQU SYSSEG + SYSSIZE
    40                                  
    41                                  
    42                                  entry:
    43 00000000 E90000                  		jmp near start
    44                                  
    45                                  ; program start here
    46                                  start:
    47                                  ; 拷贝bootsect程序到新的位置继续执行
    48 00000003 B8C007                  		mov ax, BOOTSEG
    49 00000006 8ED8                    		mov ds, ax
    50 00000008 B80090                  		mov ax, INITSEG
    51 0000000B 8EC0                    		mov es, ax
    52 0000000D B90001                  		mov cx, 256
    53 00000010 29F6                    		sub si, si
    54 00000012 29FF                    		sub di, di
    55 00000014 F3A5                    		rep movsw
    56 00000016 EA[1B00]0090            		jmp INITSEG:go 		; 段间跳转
    57 0000001B B80090                  go:		mov ax, INITSEG 	; 在0x9000:go处执行该程序
    58 0000001E 8ED8                    		mov ds, ax
    59 00000020 8EC0                    		mov es, ax
    60                                  ; 设置堆栈， 0x9ff00，接近64KB堆栈空间
    61                                  ; 保持在0xa0000内（可用内存），尽可能大
    62 00000022 8ED0                    		mov ss, ax
    63 00000024 BC00FF                  		mov sp, 0xff00
    64                                  
    65                                  ; 加载init程序到0x90200开始的内存中
    66                                  load_setup:
    67 00000027 BA0000                  		mov dx, 0x0000		; drive 0, head 0
    68 0000002A B90200                  		mov cx, 0x0002		; sector 2, track 0 读取第2~5个扇区
    69 0000002D BB0002                  		mov bx, 0x0200		; es:bx缓冲区地址
    70 00000030 B80402                  		mov ax, 0x0200+SETUPLEN
    71 00000033 CD13                    		int 0x13			; 读取setup程序
    72 00000035 730B                    		jnc ok_load_setup
    73                                  ; 读取失败，复位磁盘，重新读取
    74 00000037 BA0000                  		mov dx, 0x0000
    75 0000003A B80000                  		mov ax, 0x0000
    76 0000003D CD13                    		int 0x13
    77 0000003F E9E5FF                  		jmp near load_setup
    78                                  ; 读取驱动器参数
    79                                  ok_load_setup:
    80 00000042 B200                    		mov dl, 0x00
    81 00000044 B80008                  		mov ax, 0x0800		; AH=0x08
    82 00000047 CD13                    		int 0x13
    83 00000049 B500                    		mov ch, 0x00
    84 0000004B B80090                  		mov ax, INITSEG
    85 0000004E 8EC0                    		mov es, ax
    86                                  
    87                                  ; 打印简单信息
    88 00000050 B403                    		mov ah, 0x03		; 读取光标
    89 00000052 30FF                    		xor bh, bh			
    90 00000054 CD10                    		int 0x10
    91                                  
    92 00000056 B91800                  		mov cx, 24
    93 00000059 BB0400                  		mov bx, 0x0004
    94 0000005C BD[6400]                		mov bp, msg1
    95 0000005F B80113                  		mov ax, 0x1301
    96 00000062 CD10                    		int 0x10
    97                                  
    98                                  
    99                                  msg1:
   100 00000064 0D0A                    		db 0x0d, 0x0a
   101 00000066 4C6F6164696E672073-     		db "Loading system..."
   101 0000006F 797374656D2E2E2E   
   102 00000077 0D0A0D0A                		db 0x0d, 0x0a, 0x0d, 0x0a
   103                                  
   104                                  end:
   105 0000007B 00<rept>                		times 510-($-$$) db 0
   106 000001FE 55AA                    		db 0x55, 0xaa
   107                                  
   108                                  
